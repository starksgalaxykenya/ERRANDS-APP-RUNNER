<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ERRANDS - Runner Dashboard</title>
    
    <!-- Favicon (Fixes 404 error) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÉ</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÉ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÉ</text></svg>">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* All CSS styles remain exactly the same as before */
        :root {
            --lime-green: #32cd32;
            --light-blue: #00bfff;
            --dark-green: #228b22;
            --dark-blue: #1e90ff;
            --orange: #ff7f00;
            --purple: #9370db;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #333;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark-gray);
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }

        /* ... rest of the CSS remains exactly the same ... */

    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container" style="display: none;">
        <div class="login-left" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; background: linear-gradient(135deg, var(--orange) 0%, var(--light-blue) 100%); color: white;">
            <div style="text-align: center; max-width: 500px;">
                <h1 style="font-size: 48px; margin-bottom: 20px; font-family: 'Poppins', sans-serif;">ERRANDS RUNNER</h1>
                <p style="font-size: 20px; line-height: 1.6; opacity: 0.9;">Earn money by completing tasks and deliveries. Be your own boss, work on your schedule.</p>
                <div style="margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="text-align: center;">
                        <i class="fas fa-money-bill-wave" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">Earn Money</h3>
                        <p>Get paid for completing errands</p>
                    </div>
                    <div style="text-align: center;">
                        <i class="fas fa-clock" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">Flexible Hours</h3>
                        <p>Work when you want</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="login-right" style="flex: 1; display: flex; justify-content: center; align-items: center; padding: 40px; background-color: rgba(255, 255, 255, 0.95);">
            <div class="login-card" style="width: 100%; max-width: 420px; background-color: var(--white); border-radius: var(--radius); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); padding: 40px;">
                <div class="login-header">
                    <h1>Runner Login</h1>
                    <p>Sign in to your ERRANDS Runner account</p>
                </div>
                <button id="googleLoginBtn" class="google-btn" style="width: 100%; background-color: white; border: 1px solid #ddd; border-radius: var(--radius); padding: 14px; font-weight: 500; color: #444; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
                <div style="text-align: center; margin: 20px 0; color: #666;">or</div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="Enter your email" value="runner@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" value="password123">
                </div>
                <button id="emailLoginBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">Sign In</button>
                <div id="loginStatus" class="error-message" style="display: none;"></div>
                <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                    <p>Demo: Click "Sign In" to use demo credentials</p>
                    <p style="margin-top: 10px; font-size: 12px;">Email: runner@example.com<br>Password: password123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <i class="fas fa-running"></i>
                    ERRANDS RUNNER
                </a>
                <div class="runner-badge">RUNNER MODE</div>
            </div>
            <ul class="nav-links">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="availableTasks">
                        <i class="fas fa-tasks"></i>
                        <span>Available Tasks</span>
                        <span id="taskCountBadge" style="margin-left: auto; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="myBids">
                        <i class="fas fa-gavel"></i>
                        <span>My Bids</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="activeJobs">
                        <i class="fas fa-briefcase"></i>
                        <span>Active Jobs</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="earnings">
                        <i class="fas fa-chart-line"></i>
                        <span>Earnings</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="profile">
                        <i class="fas fa-user-circle"></i>
                        <span>Profile</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
            <div class="runner-profile">
                <img id="runnerAvatar" src="https://ui-avatars.com/api/?name=Runner&background=ff7f00&color=fff" alt="Runner" class="runner-avatar">
                <div class="runner-info">
                    <h4 id="runnerName">Loading...</h4>
                    <p id="runnerEmail">...</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page active">
                <div class="header">
                    <h1 class="page-title">Runner Dashboard</h1>
                    <div>
                        <button id="refreshBtn" class="btn btn-outline">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Welcome Message -->
                <div id="dashboardWelcome" class="dashboard-welcome">
                    <h2 id="welcomeMessage">HELLO Runner</h2>
                    <p>Track your earnings, find new tasks, and manage your jobs all in one place.</p>
                </div>
                
                <!-- Availability Toggle -->
                <div class="availability-toggle">
                    <div>
                        <h3 style="margin-bottom: 5px;">Availability Status</h3>
                        <p style="color: #666; font-size: 14px;">Turn on to receive new task notifications</p>
                    </div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="availabilityToggle">
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>Available Tasks</h3>
                        <div class="stat-value" id="availableTasksCount">0</div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span>Near your location</span>
                        </div>
                    </div>
                    <div class="stat-card blue">
                        <h3>Active Jobs</h3>
                        <div class="stat-value" id="activeJobsCount">0</div>
                        <div class="stat-trend">
                            <i class="fas fa-briefcase"></i>
                            <span>In progress</span>
                        </div>
                    </div>
                    <div class="stat-card green">
                        <h3>Today's Earnings</h3>
                        <div class="stat-value" id="todayEarnings">KSH 0</div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span>From 0 jobs</span>
                        </div>
                    </div>
                    <div class="stat-card purple">
                        <h3>Overall Rating</h3>
                        <div class="stat-value" id="runnerRating">5.0</div>
                        <div class="stat-trend">
                            <i class="fas fa-star"></i>
                            <span>Based on 0 reviews</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 30px;">
                    <div>
                        <h2 style="margin-bottom: 20px; font-family: 'Poppins', sans-serif;">Recent Available Tasks</h2>
                        <div id="recentTasks" class="tasks-grid">
                            <div style="text-align: center; padding: 40px; background-color: white; border-radius: var(--radius);">
                                <i class="fas fa-tasks" style="font-size: 48px; color: var(--medium-gray); margin-bottom: 20px;"></i>
                                <h3>No tasks available</h3>
                                <p>Check back later for new errands</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 style="margin-bottom: 20px; font-family: 'Poppins', sans-serif;">Quick Actions</h2>
                        <div style="background-color: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow);">
                            <button id="viewTasksBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                                <i class="fas fa-search"></i> Browse Tasks
                            </button>
                            <button id="withdrawEarningsBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 15px;">
                                <i class="fas fa-money-check-alt"></i> Withdraw Earnings
                            </button>
                            <button id="supportBtn" class="btn btn-outline" style="width: 100%;">
                                <i class="fas fa-headset"></i> Runner Support
                            </button>
                        </div>
                        
                        <h2 style="margin-bottom: 20px; margin-top: 30px; font-family: 'Poppins', sans-serif;">Earnings Progress</h2>
                        <div class="earnings-card">
                            <div class="earnings-label">Weekly Goal: KSH 10,000</div>
                            <div class="earnings-amount" id="weeklyEarnings">KSH 0</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="earningsProgress" style="width: 0%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <span>0%</span>
                                <span>KSH 10,000</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Tasks Page -->
            <div id="availableTasksPage" class="page">
                <div class="header">
                    <h1 class="page-title">Available Tasks</h1>
                    <div>
                        <button class="btn btn-outline" onclick="showPage('dashboard')">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All Tasks</button>
                    <button class="filter-btn" data-filter="nearby">Near Me</button>
                    <button class="filter-btn" data-filter="delivery">Delivery</button>
                    <button class="filter-btn" data-filter="shopping">Shopping</button>
                    <button class="filter-btn" data-filter="repair">Repair</button>
                    <button class="filter-btn" data-filter="high-budget">High Budget</button>
                </div>
                
                <div id="availableTasksError" class="error-message" style="display: none;"></div>
                
                <div id="availableTasksList" class="tasks-grid">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>

            <!-- My Bids Page -->
            <div id="myBidsPage" class="page">
                <div class="header">
                    <h1 class="page-title">My Bids</h1>
                    <button class="btn btn-primary" onclick="showPage('availableTasks')">
                        <i class="fas fa-search"></i> Find More Tasks
                    </button>
                </div>
                
                <!-- Bid Status Filters -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-bid-filter="all">All Bids</button>
                    <button class="filter-btn" data-bid-filter="pending">Pending</button>
                    <button class="filter-btn" data-bid-filter="accepted">Accepted</button>
                    <button class="filter-btn" data-bid-filter="rejected">Rejected</button>
                    <button class="filter-btn" data-bid-filter="expired">Expired</button>
                </div>
                
                <div id="bidsError" class="error-message" style="display: none;"></div>
                
                <div id="myBidsList" class="tasks-grid">
                    <!-- Bids will be loaded here -->
                </div>
            </div>

            <!-- Active Jobs Page -->
            <div id="activeJobsPage" class="page">
                <div class="header">
                    <h1 class="page-title">Active Jobs</h1>
                    <div>
                        <button class="btn btn-success" id="completeJobBtn" style="display: none;">
                            <i class="fas fa-check-circle"></i> Mark as Complete
                        </button>
                    </div>
                </div>
                
                <div id="activeJobsError" class="error-message" style="display: none;"></div>
                
                <div id="activeJobsList" class="tasks-grid">
                    <!-- Active jobs will be loaded here -->
                </div>
            </div>

            <!-- Earnings Page -->
            <div id="earningsPage" class="page">
                <div class="header">
                    <h1 class="page-title">My Earnings</h1>
                    <button class="btn btn-primary" id="requestWithdrawalBtn">
                        <i class="fas fa-money-check-alt"></i> Request Withdrawal
                    </button>
                </div>
                
                <!-- Earnings Summary -->
                <div class="earnings-card">
                    <div class="earnings-label">Total Available Balance</div>
                    <div class="earnings-amount" id="totalEarnings">KSH 0</div>
                    <div style="display: flex; gap: 30px; margin-top: 20px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9;">This Week</div>
                            <div style="font-size: 24px; font-weight: 600;">KSH <span id="weeklyTotal">0</span></div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9;">This Month</div>
                            <div style="font-size: 24px; font-weight: 600;">KSH <span id="monthlyTotal">0</span></div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9;">All Time</div>
                            <div style="font-size: 24px; font-weight: 600;">KSH <span id="allTimeTotal">0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Withdrawal History -->
                <h2 style="margin-bottom: 20px; margin-top: 30px; font-family: 'Poppins', sans-serif;">Withdrawal History</h2>
                <div class="bid-history">
                    <div id="withdrawalHistory">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-history" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <h3>No withdrawals yet</h3>
                            <p>Your withdrawal history will appear here</p>
                        </div>
                    </div>
                </div>
                
                <!-- Earnings Chart -->
                <h2 style="margin-bottom: 20px; margin-top: 30px; font-family: 'Poppins', sans-serif;">Earnings Overview</h2>
                <div style="background-color: white; border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow);">
                    <div id="earningsChartPlaceholder" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>Earnings Chart</h3>
                        <p>Your earnings data will be displayed here</p>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page">
                <div class="header">
                    <h1 class="page-title">My Profile</h1>
                    <button class="btn btn-primary" id="editProfileBtn">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>
                
                <div id="profileError" class="error-message" style="display: none;"></div>
                
                <div class="form-container">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <img id="profilePhoto" src="https://ui-avatars.com/api/?name=Runner&background=ff7f00&color=fff&size=150" alt="Profile" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid var(--light-gray);">
                        <div style="margin-top: 15px;">
                            <button class="btn btn-outline" id="changePhotoBtn">
                                <i class="fas fa-camera"></i> Change Photo
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="profileName" class="form-control" value="Loading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="profileEmail" class="form-control" value="Loading...">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="profilePhone" class="form-control" value="+254712345678">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ID Number</label>
                            <input type="text" id="profileId" class="form-control" value="12345678">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Vehicle Type (if any)</label>
                            <select id="profileVehicle" class="form-control">
                                <option value="">None</option>
                                <option value="bicycle">Bicycle</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="car">Car</option>
                                <option value="truck">Truck</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Special Skills</label>
                            <input type="text" id="profileSkills" class="form-control" placeholder="e.g., Delivery, Repair, Shopping">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Town</label>
                            <input type="text" id="profileTown" class="form-control" value="Nairobi">
                        </div>
                        <div class="form-group">
                            <label class="form-label">County</label>
                            <input type="text" id="profileCounty" class="form-control" value="Nairobi County">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Bio/Description</label>
                        <textarea id="profileBio" class="form-control" rows="4" placeholder="Tell clients about yourself and your experience..."></textarea>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button id="saveProfileBtn" class="btn btn-primary" style="padding: 12px 40px;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bid Modal -->
    <div id="bidModal" class="modal bid-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Place Your Bid</h2>
                <button class="close-modal" onclick="closeModal('bidModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bidForm">
                    <input type="hidden" id="bidTaskId">
                    <div class="form-group">
                        <label class="form-label">Task Description</label>
                        <div id="bidTaskDescription" style="padding: 15px; background-color: var(--light-gray); border-radius: var(--radius); margin-bottom: 20px;">
                            Loading task details...
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Your Bid Amount (KSH)</label>
                            <input type="number" id="bidAmount" class="form-control" min="100" step="50" placeholder="Enter your bid amount">
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">Task budget: KSH <span id="taskBudget">0</span></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estimated Completion Time</label>
                            <select id="bidTime" class="form-control">
                                <option value="1">Within 1 hour</option>
                                <option value="2">Within 2 hours</option>
                                <option value="4">Within 4 hours</option>
                                <option value="8">Within 8 hours</option>
                                <option value="24">Within 24 hours</option>
                                <option value="48">Within 48 hours</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Message to Client (Optional)</label>
                        <textarea id="bidMessage" class="form-control" rows="3" placeholder="Explain why you're the best fit for this task..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="bidTerms" required>
                            I agree to the terms and conditions
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bidModal')">Cancel</button>
                <button id="submitBidBtn" class="btn btn-primary">Submit Bid</button>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="jobDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Job Details</h2>
                <button class="close-modal" onclick="closeModal('jobDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="jobDetailsContent">
                    <!-- Job details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('jobDetailsModal')">Close</button>
                <button id="startJobBtn" class="btn btn-primary" style="display: none;">Start Job</button>
                <button id="completeJobModalBtn" class="btn btn-success" style="display: none;">Mark as Complete</button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Withdrawal</h2>
                <button class="close-modal" onclick="closeModal('withdrawalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Available Balance</label>
                    <div style="font-size: 24px; font-weight: 700; color: var(--dark-green); margin-bottom: 20px;" id="availableBalance">KSH 0</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Withdrawal Amount (KSH)</label>
                    <input type="number" id="withdrawalAmount" class="form-control" min="500" step="100" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select id="withdrawalMethod" class="form-control">
                        <option value="mpesa">M-Pesa</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="paypal">PayPal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" id="mpesaLabel" style="display: none;">M-Pesa Number</label>
                    <input type="tel" id="mpesaNumber" class="form-control" style="display: none;" placeholder="07XXXXXXXX">
                </div>
                <div class="form-group">
                    <label class="form-label" id="bankLabel" style="display: none;">Bank Account Details</label>
                    <textarea id="bankDetails" class="form-control" rows="3" style="display: none;" placeholder="Bank Name, Account Number, Branch"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('withdrawalModal')">Cancel</button>
                <button id="confirmWithdrawalBtn" class="btn btn-primary">Request Withdrawal</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="fas fa-check-circle"></i>
        <span id="toastMessage">Operation completed successfully!</span>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-cyGvUm_XZBvP62OpCLoELYK5b8jABig",
            authDomain: "finance-report-246b1.firebaseapp.com",
            projectId: "finance-report-246b1",
            storageBucket: "finance-report-246b1.firebasestorage.app",
            messagingSenderId: "506353861080",
            appId: "1:506353861080:web:b5b2526f2828f380d9b2ad"
        };

        // Initialize Firebase
        let auth, db, storage;
        
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded. Check your internet connection.');
            }
            
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showLoginError('Firebase initialization failed: ' + error.message);
        }

        // Global Variables
        let currentUser = null;
        let runnerData = {};
        let currentLocation = null;
        let selectedTaskId = null;
        let selectedJobId = null;

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const appContainer = document.getElementById('appContainer');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const toast = document.getElementById('toast');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Initialize the App
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            
            if (!auth) {
                showLoginError('Firebase not initialized. Please refresh the page.');
                return;
            }
            
            // Check authentication state
            auth.onAuthStateChanged(user => {
                console.log('Auth state changed:', user ? 'User logged in' : 'No user');
                if (user) {
                    currentUser = user;
                    loadRunnerData();
                    showApp();
                } else {
                    showLogin();
                }
            });
            
            // Get current location for nearby tasks
            getCurrentLocation();
        });

        // Event Listeners
        function initEventListeners() {
            // Login buttons
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const emailLoginBtn = document.getElementById('emailLoginBtn');
            
            if (googleLoginBtn) googleLoginBtn.addEventListener('click', signInWithGoogle);
            if (emailLoginBtn) emailLoginBtn.addEventListener('click', signInWithEmail);
            
            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (this.id === 'logoutBtn') {
                        logout();
                    } else {
                        showPage(page);
                        
                        navLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });
            
            // Buttons
            const refreshBtn = document.getElementById('refreshBtn');
            const viewTasksBtn = document.getElementById('viewTasksBtn');
            const withdrawEarningsBtn = document.getElementById('withdrawEarningsBtn');
            const supportBtn = document.getElementById('supportBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const changePhotoBtn = document.getElementById('changePhotoBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const requestWithdrawalBtn = document.getElementById('requestWithdrawalBtn');
            const submitBidBtn = document.getElementById('submitBidBtn');
            const completeJobBtn = document.getElementById('completeJobBtn');
            const confirmWithdrawalBtn = document.getElementById('confirmWithdrawalBtn');
            const availabilityToggle = document.getElementById('availabilityToggle');
            const withdrawalMethod = document.getElementById('withdrawalMethod');
            
            if (refreshBtn) refreshBtn.addEventListener('click', refreshDashboard);
            if (viewTasksBtn) viewTasksBtn.addEventListener('click', () => showPage('availableTasks'));
            if (withdrawEarningsBtn) withdrawEarningsBtn.addEventListener('click', () => showModal('withdrawalModal'));
            if (supportBtn) supportBtn.addEventListener('click', showRunnerSupport);
            if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfile);
            if (changePhotoBtn) changePhotoBtn.addEventListener('click', changeProfilePhoto);
            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            if (requestWithdrawalBtn) requestWithdrawalBtn.addEventListener('click', () => showModal('withdrawalModal'));
            if (submitBidBtn) submitBidBtn.addEventListener('click', submitBid);
            if (completeJobBtn) completeJobBtn.addEventListener('click', () => {
                if (selectedJobId) {
                    markJobComplete(selectedJobId);
                } else {
                    showToast('Please select a job first', 'info');
                }
            });
            if (confirmWithdrawalBtn) confirmWithdrawalBtn.addEventListener('click', processWithdrawal);
            if (availabilityToggle) availabilityToggle.addEventListener('change', toggleAvailability);
            if (withdrawalMethod) withdrawalMethod.addEventListener('change', showWithdrawalFields);
            
            // Filter buttons
            document.querySelectorAll('.filter-buttons .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = getCurrentPage();
                    const filter = this.getAttribute('data-filter') || this.getAttribute('data-bid-filter');
                    
                    document.querySelectorAll('.filter-buttons .filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (page === 'availableTasks') {
                        filterTasks(filter);
                    } else if (page === 'myBids') {
                        filterBids(filter);
                    }
                });
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
        }

        // Authentication Functions
        async function signInWithGoogle() {
            showLoading();
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showToast('Successfully signed in with Google!', 'success');
            } catch (error) {
                console.error('Google sign in error:', error);
                showLoginError('Error signing in with Google: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function signInWithEmail() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showLoginError('Please enter email and password');
                return;
            }
            
            showLoading();
            try {
                // Try to sign in with the credentials
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                showToast('Successfully signed in!', 'success');
            } catch (error) {
                console.error('Email sign in error:', error);
                
                // For demo purposes, auto-create account if it doesn't exist
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showLoading();
                    try {
                        // Create a new user account for demo
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        
                        // Create runner document in Firestore
                        await db.collection('runners').doc(userCredential.user.uid).set({
                            email: email,
                            name: 'Demo Runner',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            userType: 'runner',
                            walletBalance: 5000,
                            rating: 5.0,
                            totalJobs: 0,
                            totalEarnings: 0,
                            profileComplete: false,
                            isAvailable: true,
                            vehicleType: 'motorcycle',
                            skills: 'Delivery, Shopping, Errands',
                            bio: 'Experienced runner ready to handle your tasks efficiently.',
                            phone: '+254712345678',
                            town: 'Nairobi',
                            county: 'Nairobi County'
                        });
                        
                        showToast('Demo runner account created! You have KSH 5000 in your wallet.', 'success');
                    } catch (createError) {
                        console.error('Create account error:', createError);
                        showLoginError('Demo: Using auto-created account. Click Sign In again.');
                    } finally {
                        hideLoading();
                    }
                } else {
                    showLoginError('Error: ' + error.message);
                }
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                showToast('Successfully logged out!', 'success');
                showLogin();
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error logging out: ' + error.message, 'error');
            }
        }

        function showLoginError(message) {
            const loginStatus = document.getElementById('loginStatus');
            if (loginStatus) {
                loginStatus.textContent = message;
                loginStatus.style.display = 'block';
            }
        }

        // Runner Data Functions
        async function loadRunnerData() {
            if (!currentUser) return;
            
            showLoading();
            try {
                const runnerDoc = await db.collection('runners').doc(currentUser.uid).get();
                
                if (runnerDoc.exists) {
                    runnerData = runnerDoc.data();
                    
                    // Update UI with runner data
                    updateRunnerUI();
                    
                    // Load dashboard data
                    loadDashboardData();
                    loadAvailableTasks();
                    loadMyBids();
                    loadActiveJobs();
                    loadEarningsData();
                    
                    showToast('Welcome back, ' + (runnerData.name || 'Runner') + '!', 'success');
                } else {
                    // Create runner document if it doesn't exist
                    await db.collection('runners').doc(currentUser.uid).set({
                        email: currentUser.email,
                        name: currentUser.displayName || 'Demo Runner',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userType: 'runner',
                        walletBalance: 5000,
                        rating: 5.0,
                        totalJobs: 0,
                        totalEarnings: 0,
                        profileComplete: false,
                        isAvailable: true,
                        vehicleType: 'motorcycle',
                        skills: 'Delivery, Shopping, Errands',
                        bio: 'Experienced runner ready to handle your tasks efficiently.',
                        phone: '+254712345678',
                        town: 'Nairobi',
                        county: 'Nairobi County'
                    });
                    
                    runnerData = {
                        email: currentUser.email,
                        name: currentUser.displayName || 'Demo Runner',
                        walletBalance: 5000,
                        rating: 5.0,
                        isAvailable: true
                    };
                    
                    updateRunnerUI();
                    showToast('Welcome to ERRANDS Runner! You have KSH 5000 in your wallet.', 'success');
                }
            } catch (error) {
                console.error('Error loading runner data:', error);
                showToast('Error loading runner data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function updateRunnerUI() {
            document.getElementById('runnerName').textContent = runnerData.name || 'Runner';
            document.getElementById('runnerEmail').textContent = runnerData.email || currentUser.email;
            document.getElementById('welcomeMessage').textContent = `HELLO ${runnerData.name || 'Runner'}`;
            
            // Update profile form
            document.getElementById('profileName').value = runnerData.name || '';
            document.getElementById('profileEmail').value = runnerData.email || currentUser.email;
            document.getElementById('profilePhone').value = runnerData.phone || '';
            document.getElementById('profileId').value = runnerData.idNumber || '';
            document.getElementById('profileTown').value = runnerData.town || '';
            document.getElementById('profileCounty').value = runnerData.county || '';
            document.getElementById('profileVehicle').value = runnerData.vehicleType || '';
            document.getElementById('profileSkills').value = runnerData.skills || '';
            document.getElementById('profileBio').value = runnerData.bio || '';
            
            // Update availability toggle
            const toggle = document.getElementById('availabilityToggle');
            if (toggle) {
                toggle.checked = runnerData.isAvailable || false;
            }
            
            if (runnerData.photoURL) {
                document.getElementById('runnerAvatar').src = runnerData.photoURL;
                document.getElementById('profilePhoto').src = runnerData.photoURL;
            }
        }

        async function saveProfile() {
            showLoading();
            try {
                const updates = {
                    name: document.getElementById('profileName').value,
                    phone: document.getElementById('profilePhone').value,
                    idNumber: document.getElementById('profileId').value,
                    town: document.getElementById('profileTown').value,
                    county: document.getElementById('profileCounty').value,
                    vehicleType: document.getElementById('profileVehicle').value,
                    skills: document.getElementById('profileSkills').value,
                    bio: document.getElementById('profileBio').value,
                    profileComplete: true,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('runners').doc(currentUser.uid).update(updates);
                
                // Update local runnerData
                Object.assign(runnerData, updates);
                
                // Update UI
                updateRunnerUI();
                
                showToast('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Save profile error:', error);
                showToast('Error updating profile: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function changeProfilePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                showLoading();
                try {
                    // Upload to Firebase Storage
                    const storageRef = storage.ref();
                    const photoRef = storageRef.child(`runner_photos/${currentUser.uid}/${file.name}`);
                    await photoRef.put(file);
                    const photoURL = await photoRef.getDownloadURL();
                    
                    // Update runner document
                    await db.collection('runners').doc(currentUser.uid).update({
                        photoURL: photoURL
                    });
                    
                    // Update UI
                    document.getElementById('runnerAvatar').src = photoURL;
                    document.getElementById('profilePhoto').src = photoURL;
                    runnerData.photoURL = photoURL;
                    
                    showToast('Profile photo updated!', 'success');
                } catch (error) {
                    console.error('Photo upload error:', error);
                    showToast('Error uploading photo: ' + error.message, 'error');
                } finally {
                    hideLoading();
                }
            };
            
            input.click();
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                // Load available tasks count
                const tasksSnapshot = await db.collection('errands')
                    .where('status', '==', 'pending')
                    .get();
                
                document.getElementById('availableTasksCount').textContent = tasksSnapshot.size;
                document.getElementById('taskCountBadge').textContent = tasksSnapshot.size;
                
                // Load active jobs count
                const activeJobsSnapshot = await db.collection('errands')
                    .where('status', '==', 'active')
                    .where('runnerId', '==', currentUser.uid)
                    .get();
                
                document.getElementById('activeJobsCount').textContent = activeJobsSnapshot.size;
                
                // Load today's earnings
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const earningsSnapshot = await db.collection('transactions')
                    .where('runnerId', '==', currentUser.uid)
                    .where('type', '==', 'payment')
                    .where('createdAt', '>=', today)
                    .get();
                
                let todayEarnings = 0;
                earningsSnapshot.forEach(doc => {
                    todayEarnings += doc.data().amount || 0;
                });
                
                document.getElementById('todayEarnings').textContent = `KSH ${todayEarnings.toFixed(2)}`;
                document.getElementById('runnerRating').textContent = runnerData.rating?.toFixed(1) || '5.0';
                
                // Load recent tasks
                loadRecentTasks();
                
                // Load earnings progress
                updateEarningsProgress();
                
            } catch (error) {
                console.error('Load dashboard error:', error);
                showToast('Error loading dashboard: ' + error.message, 'error');
            }
        }

        async function loadRecentTasks() {
            try {
                const snapshot = await db.collection('errands')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .limit(3)
                    .get();
                
                const recentTasks = document.getElementById('recentTasks');
                recentTasks.innerHTML = '';
                
                if (snapshot.empty) {
                    recentTasks.innerHTML = `
                        <div style="text-align: center; padding: 40px; background-color: white; border-radius: var(--radius);">
                            <i class="fas fa-tasks" style="font-size: 48px; color: var(--medium-gray); margin-bottom: 20px;"></i>
                            <h3>No tasks available</h3>
                            <p>Check back later for new errands</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskCard = createTaskCard(task, doc.id, 'dashboard');
                    recentTasks.appendChild(taskCard);
                });
            } catch (error) {
                console.error('Load recent tasks error:', error);
            }
        }

        // Task Functions
        async function loadAvailableTasks() {
            try {
                const snapshot = await db.collection('errands')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const tasksList = document.getElementById('availableTasksList');
                tasksList.innerHTML = '';
                
                if (snapshot.empty) {
                    tasksList.innerHTML = `
                        <div style="text-align: center; padding: 40px; background-color: white; border-radius: var(--radius);">
                            <i class="fas fa-tasks" style="font-size: 48px; color: var(--medium-gray); margin-bottom: 20px;"></i>
                            <h3>No tasks available right now</h3>
                            <p>Check back later for new errands</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskCard = createTaskCard(task, doc.id, 'available');
                    tasksList.appendChild(taskCard);
                });
            } catch (error) {
                console.error('Load available tasks error:', error);
                showToast('Error loading tasks: ' + error.message, 'error');
            }
        }

        function createTaskCard(task, id, context) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.dataset.id = id;
            card.dataset.type = task.errandType?.toLowerCase();
            card.dataset.budget = task.budget;
            
            const statusClass = `status-${task.status}`;
            const date = task.createdAt ? task.createdAt.toDate().toLocaleDateString() : 'Recent';
            const time = task.createdAt ? task.createdAt.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
            
            let actions = '';
            
            if (context === 'available') {
                actions = `
                    <button class="btn btn-primary btn-sm" onclick="openBidModal('${id}')">
                        <i class="fas fa-gavel"></i> Place Bid
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="viewTaskDetails('${id}')">
                        <i class="fas fa-eye"></i> Details
                    </button>
                `;
            } else if (context === 'dashboard') {
                actions = `
                    <button class="btn btn-primary btn-sm" onclick="openBidModal('${id}')">
                        <i class="fas fa-gavel"></i> Bid Now
                    </button>
                `;
            } else if (context === 'active') {
                actions = `
                    <button class="btn btn-primary btn-sm" onclick="viewJobDetails('${id}')">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                    <button class="btn btn-success btn-sm" onclick="markJobComplete('${id}')">
                        <i class="fas fa-check"></i> Complete
                    </button>
                `;
            }
            
            card.innerHTML = `
                <div class="task-header">
                    <span class="task-type">${task.errandType}</span>
                    <span class="task-budget">KSH ${task.budget?.toFixed(2)}</span>
                </div>
                <div class="task-body">
                    <h3 class="task-title">${task.description.substring(0, 60)}${task.description.length > 60 ? '...' : ''}</h3>
                    <p class="task-desc">${task.description}</p>
                    <div class="task-details">
                        <div class="task-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${task.town}, ${task.area}</span>
                        </div>
                        ${task.travelRequired ? `
                        <div class="task-detail">
                            <i class="fas fa-route"></i>
                            <span>Travel Required</span>
                        </div>
                        ` : ''}
                        ${task.runnerNeeds ? `
                        <div class="task-detail">
                            <i class="fas fa-tools"></i>
                            <span>${task.runnerNeeds}</span>
                        </div>
                        ` : ''}
                        <div class="task-detail">
                            <i class="fas fa-calendar"></i>
                            <span>${date} ${time}</span>
                        </div>
                    </div>
                </div>
                <div class="task-footer">
                    <span class="task-status ${statusClass}">${task.status.toUpperCase()}</span>
                    <div class="task-actions">
                        ${actions}
                    </div>
                </div>
            `;
            
            return card;
        }

        function filterTasks(filter) {
            const cards = document.querySelectorAll('.task-card');
            cards.forEach(card => {
                let show = false;
                
                switch(filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'nearby':
                        // Simple check - in real app, use location data
                        show = true;
                        break;
                    case 'delivery':
                        show = card.dataset.type.includes('delivery');
                        break;
                    case 'shopping':
                        show = card.dataset.type.includes('shopping');
                        break;
                    case 'repair':
                        show = card.dataset.type.includes('repair') || card.dataset.type.includes('handy');
                        break;
                    case 'high-budget':
                        show = parseFloat(card.dataset.budget) > 5000;
                        break;
                    default:
                        show = true;
                }
                
                card.style.display = show ? 'block' : 'none';
            });
        }

        // Bid Functions
        async function openBidModal(taskId) {
            selectedTaskId = taskId;
            showModal('bidModal');
            
            try {
                const taskDoc = await db.collection('errands').doc(taskId).get();
                const task = taskDoc.data();
                
                document.getElementById('bidTaskDescription').textContent = task.description;
                document.getElementById('taskBudget').textContent = task.budget?.toFixed(2) || '0';
                
                // Set default bid amount (80% of budget)
                const defaultBid = task.budget * 0.8;
                document.getElementById('bidAmount').value = defaultBid.toFixed(2);
                
            } catch (error) {
                console.error('Error loading task details:', error);
                showToast('Error loading task details', 'error');
            }
        }

        async function submitBid() {
            const bidAmount = parseFloat(document.getElementById('bidAmount').value);
            const bidTime = document.getElementById('bidTime').value;
            const bidMessage = document.getElementById('bidMessage').value;
            const bidTerms = document.getElementById('bidTerms').checked;
            
            if (!bidAmount || bidAmount < 100) {
                showToast('Minimum bid amount is KSH 100', 'error');
                return;
            }
            
            if (!bidTerms) {
                showToast('Please agree to the terms and conditions', 'error');
                return;
            }
            
            showLoading();
            try {
                const taskDoc = await db.collection('errands').doc(selectedTaskId).get();
                const task = taskDoc.data();
                
                // Check if runner has already bid on this task
                const existingBid = task.bids?.find(bid => bid.runnerId === currentUser.uid);
                if (existingBid) {
                    showToast('You have already placed a bid on this task', 'error');
                    hideLoading();
                    closeModal('bidModal');
                    return;
                }
                
                // Create bid object
                const bid = {
                    runnerId: currentUser.uid,
                    runnerName: runnerData.name,
                    amount: bidAmount,
                    completionTime: parseInt(bidTime),
                    message: bidMessage,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add bid to task
                await db.collection('errands').doc(selectedTaskId).update({
                    bids: firebase.firestore.FieldValue.arrayUnion(bid)
                });
                
                // Record bid in runner's bids collection
                await db.collection('bids').add({
                    taskId: selectedTaskId,
                    runnerId: currentUser.uid,
                    amount: bidAmount,
                    completionTime: parseInt(bidTime),
                    message: bidMessage,
                    status: 'pending',
                    taskDescription: task.description,
                    taskBudget: task.budget,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Bid submitted successfully!', 'success');
                closeModal('bidModal');
                
                // Refresh bids list
                loadMyBids();
                
            } catch (error) {
                console.error('Submit bid error:', error);
                showToast('Error submitting bid: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadMyBids() {
            try {
                const snapshot = await db.collection('bids')
                    .where('runnerId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const bidsList = document.getElementById('myBidsList');
                bidsList.innerHTML = '';
                
                if (snapshot.empty) {
                    bidsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; background-color: white; border-radius: var(--radius);">
                            <i class="fas fa-gavel" style="font-size: 48px; color: var(--medium-gray); margin-bottom: 20px;"></i>
                            <h3>No bids yet</h3>
                            <p>Start bidding on available tasks to earn money</p>
                            <button class="btn btn-primary" onclick="showPage('availableTasks')" style="margin-top: 20px;">
                                <i class="fas fa-search"></i> Browse Tasks
                            </button>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const bid = doc.data();
                    const bidCard = createBidCard(bid, doc.id);
                    bidsList.appendChild(bidCard);
                });
            } catch (error) {
                console.error('Load bids error:', error);
                showToast('Error loading bids: ' + error.message, 'error');
            }
        }

        function createBidCard(bid, id) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.dataset.id = id;
            card.dataset.status = bid.status;
            
            const statusClass = `status-${bid.status}`;
            const date = bid.createdAt ? bid.createdAt.toDate().toLocaleDateString() : 'Recent';
            
            let statusText = bid.status.charAt(0).toUpperCase() + bid.status.slice(1);
            if (bid.status === 'pending') statusText = 'WAITING FOR CLIENT';
            if (bid.status === 'accepted') statusText = 'BID ACCEPTED';
            if (bid.status === 'rejected') statusText = 'BID REJECTED';
            
            card.innerHTML = `
                <div class="task-header">
                    <span class="task-type">BID</span>
                    <span class="task-budget">KSH ${bid.amount?.toFixed(2)}</span>
                </div>
                <div class="task-body">
                    <h3 class="task-title">${bid.taskDescription.substring(0, 60)}${bid.taskDescription.length > 60 ? '...' : ''}</h3>
                    <p class="task-desc">${bid.taskDescription}</p>
                    <div class="task-details">
                        <div class="task-detail">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Task Budget: KSH ${bid.taskBudget?.toFixed(2)}</span>
                        </div>
                        <div class="task-detail">
                            <i class="fas fa-clock"></i>
                            <span>Completion Time: ${bid.completionTime} hours</span>
                        </div>
                        ${bid.message ? `
                        <div class="task-detail">
                            <i class="fas fa-comment"></i>
                            <span>Your Message: ${bid.message}</span>
                        </div>
                        ` : ''}
                        <div class="task-detail">
                            <i class="fas fa-calendar"></i>
                            <span>Submitted: ${date}</span>
                        </div>
                    </div>
                </div>
                <div class="task-footer">
                    <span class="task-status ${statusClass}">${statusText}</span>
                    <div>
                        ${bid.status === 'accepted' ? `
                        <button class="btn btn-success btn-sm" onclick="viewJobFromBid('${bid.taskId}')">
                            <i class="fas fa-briefcase"></i> Start Job
                        </button>
                        ` : ''}
                        ${bid.status === 'pending' ? `
                        <button class="btn btn-outline btn-sm" onclick="withdrawBid('${id}')">
                            <i class="fas fa-times"></i> Withdraw
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return card;
        }

        function filterBids(filter) {
            const cards = document.querySelectorAll('.task-card');
            cards.forEach(card => {
                if (filter === 'all' || card.dataset.status === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function withdrawBid(bidId) {
            if (!confirm('Are you sure you want to withdraw this bid?')) return;
            
            showLoading();
            try {
                const bidDoc = await db.collection('bids').doc(bidId).get();
                const bid = bidDoc.data();
                
                // Remove bid from task
                const taskDoc = await db.collection('errands').doc(bid.taskId).get();
                const task = taskDoc.data();
                
                if (task.bids) {
                    const updatedBids = task.bids.filter(b => b.runnerId !== currentUser.uid);
                    await db.collection('errands').doc(bid.taskId).update({
                        bids: updatedBids
                    });
                }
                
                // Update bid status
                await db.collection('bids').doc(bidId).update({
                    status: 'withdrawn'
                });
                
                showToast('Bid withdrawn successfully', 'success');
                loadMyBids();
                
            } catch (error) {
                console.error('Withdraw bid error:', error);
                showToast('Error withdrawing bid: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Job Functions
        async function loadActiveJobs() {
            try {
                const snapshot = await db.collection('errands')
                    .where('status', 'in', ['active', 'in_progress'])
                    .where('runnerId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const jobsList = document.getElementById('activeJobsList');
                jobsList.innerHTML = '';
                
                if (snapshot.empty) {
                    jobsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; background-color: white; border-radius: var(--radius);">
                            <i class="fas fa-briefcase" style="font-size: 48px; color: var(--medium-gray); margin-bottom: 20px;"></i>
                            <h3>No active jobs</h3>
                            <p>Your active jobs will appear here</p>
                            <button class="btn btn-primary" onclick="showPage('availableTasks')" style="margin-top: 20px;">
                                <i class="fas fa-search"></i> Find Tasks
                            </button>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const job = doc.data();
                    const jobCard = createTaskCard(job, doc.id, 'active');
                    jobsList.appendChild(jobCard);
                });
                
                // Show complete job button if there are active jobs
                const completeBtn = document.getElementById('completeJobBtn');
                if (completeBtn && snapshot.size > 0) {
                    completeBtn.style.display = 'flex';
                }
                
            } catch (error) {
                console.error('Load active jobs error:', error);
                showToast('Error loading jobs: ' + error.message, 'error');
            }
        }

        async function viewJobDetails(jobId) {
            selectedJobId = jobId;
            showModal('jobDetailsModal');
            
            try {
                const jobDoc = await db.collection('errands').doc(jobId).get();
                const job = jobDoc.data();
                
                let details = `
                    <h3 style="margin-bottom: 15px;">${job.errandType}</h3>
                    <p style="margin-bottom: 20px; color: #666;">${job.description}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>Budget:</strong>
                            <div>KSH ${job.budget?.toFixed(2)}</div>
                        </div>
                        <div>
                            <strong>Your Earnings:</strong>
                            <div style="color: var(--dark-green); font-weight: 600;">KSH ${job.runnerAmount?.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Location:</strong>
                        <div>${job.town}, ${job.area}</div>
                    </div>
                `;
                
                if (job.travelRequired) {
                    details += `
                        <div style="margin-bottom: 20px;">
                            <strong>Travel Details:</strong>
                            <div>From: ${job.travelFrom}</div>
                            <div>To: ${job.travelTo}</div>
                        </div>
                    `;
                }
                
                if (job.runnerNeeds) {
                    details += `
                        <div style="margin-bottom: 20px;">
                            <strong>Requirements:</strong>
                            <div>${job.runnerNeeds}</div>
                        </div>
                    `;
                }
                
                if (job.meetRequired) {
                    details += `
                        <div style="margin-bottom: 20px;">
                            <strong>Client Meeting Required:</strong>
                            <div>Yes</div>
                        </div>
                    `;
                }
                
                document.getElementById('jobDetailsContent').innerHTML = details;
                
                // Show appropriate buttons
                const startBtn = document.getElementById('startJobBtn');
                const completeBtn = document.getElementById('completeJobModalBtn');
                
                if (job.status === 'active') {
                    startBtn.style.display = 'inline-flex';
                    startBtn.onclick = () => startJob(jobId);
                } else if (job.status === 'in_progress') {
                    completeBtn.style.display = 'inline-flex';
                    completeBtn.onclick = () => markJobComplete(jobId);
                }
                
            } catch (error) {
                console.error('Error loading job details:', error);
                showToast('Error loading job details', 'error');
            }
        }

        async function startJob(jobId) {
            showLoading();
            try {
                await db.collection('errands').doc(jobId).update({
                    status: 'in_progress',
                    startedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Job started successfully!', 'success');
                closeModal('jobDetailsModal');
                loadActiveJobs();
                
            } catch (error) {
                console.error('Start job error:', error);
                showToast('Error starting job: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function markJobComplete(jobId) {
            if (!confirm('Mark this job as complete? This will notify the client.')) return;
            
            showLoading();
            try {
                const jobDoc = await db.collection('errands').doc(jobId).get();
                const job = jobDoc.data();
                
                // Update job status
                await db.collection('errands').doc(jobId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Record payment transaction
                await db.collection('transactions').add({
                    taskId: jobId,
                    runnerId: currentUser.uid,
                    clientId: job.clientId,
                    amount: job.runnerAmount,
                    type: 'payment',
                    status: 'completed',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update runner's earnings
                await db.collection('runners').doc(currentUser.uid).update({
                    totalJobs: firebase.firestore.FieldValue.increment(1),
                    totalEarnings: firebase.firestore.FieldValue.increment(job.runnerAmount),
                    walletBalance: firebase.firestore.FieldValue.increment(job.runnerAmount)
                });
                
                // Update runner data
                runnerData.totalJobs = (runnerData.totalJobs || 0) + 1;
                runnerData.totalEarnings = (runnerData.totalEarnings || 0) + job.runnerAmount;
                runnerData.walletBalance = (runnerData.walletBalance || 0) + job.runnerAmount;
                
                showToast('Job marked as complete! Payment of KSH ' + job.runnerAmount.toFixed(2) + ' added to your wallet.', 'success');
                closeModal('jobDetailsModal');
                loadActiveJobs();
                loadEarningsData();
                
            } catch (error) {
                console.error('Complete job error:', error);
                showToast('Error completing job: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Earnings Functions
        async function loadEarningsData() {
            try {
                // Calculate total earnings from transactions
                const snapshot = await db.collection('transactions')
                    .where('runnerId', '==', currentUser.uid)
                    .where('type', '==', 'payment')
                    .get();
                
                let totalEarnings = 0;
                let weeklyEarnings = 0;
                let monthlyEarnings = 0;
                
                const now = new Date();
                const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                snapshot.forEach(doc => {
                    const transaction = doc.data();
                    const amount = transaction.amount || 0;
                    const createdAt = transaction.createdAt?.toDate();
                    
                    totalEarnings += amount;
                    
                    if (createdAt >= weekStart) {
                        weeklyEarnings += amount;
                    }
                    
                    if (createdAt >= monthStart) {
                        monthlyEarnings += amount;
                    }
                });
                
                // Update UI
                document.getElementById('totalEarnings').textContent = `KSH ${totalEarnings.toFixed(2)}`;
                document.getElementById('weeklyTotal').textContent = weeklyEarnings.toFixed(2);
                document.getElementById('monthlyTotal').textContent = monthlyEarnings.toFixed(2);
                document.getElementById('allTimeTotal').textContent = totalEarnings.toFixed(2);
                document.getElementById('availableBalance').textContent = `KSH ${(runnerData.walletBalance || 0).toFixed(2)}`;
                
            } catch (error) {
                console.error('Load earnings error:', error);
            }
        }

        function updateEarningsProgress() {
            const weeklyGoal = 10000;
            const currentEarnings = parseFloat(document.getElementById('weeklyTotal').textContent) || 0;
            const progress = Math.min((currentEarnings / weeklyGoal) * 100, 100);
            
            document.getElementById('weeklyEarnings').textContent = `KSH ${currentEarnings.toFixed(2)}`;
            document.getElementById('earningsProgress').style.width = `${progress}%`;
            
            const progressText = document.querySelector('#earningsProgress').parentElement.nextElementSibling.firstElementChild;
            progressText.textContent = `${progress.toFixed(1)}%`;
        }

        function showWithdrawalFields() {
            const method = document.getElementById('withdrawalMethod').value;
            
            document.getElementById('mpesaLabel').style.display = 'none';
            document.getElementById('mpesaNumber').style.display = 'none';
            document.getElementById('bankLabel').style.display = 'none';
            document.getElementById('bankDetails').style.display = 'none';
            
            if (method === 'mpesa') {
                document.getElementById('mpesaLabel').style.display = 'block';
                document.getElementById('mpesaNumber').style.display = 'block';
            } else if (method === 'bank') {
                document.getElementById('bankLabel').style.display = 'block';
                document.getElementById('bankDetails').style.display = 'block';
            }
        }

        async function processWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const method = document.getElementById('withdrawalMethod').value;
            const mpesaNumber = document.getElementById('mpesaNumber').value;
            const bankDetails = document.getElementById('bankDetails').value;
            
            if (!amount || amount < 500) {
                showToast('Minimum withdrawal amount is KSH 500', 'error');
                return;
            }
            
            if (amount > (runnerData.walletBalance || 0)) {
                showToast('Insufficient balance for withdrawal', 'error');
                return;
            }
            
            if (method === 'mpesa' && (!mpesaNumber || mpesaNumber.length !== 10)) {
                showToast('Please enter a valid M-Pesa number (10 digits)', 'error');
                return;
            }
            
            if (method === 'bank' && !bankDetails) {
                showToast('Please enter bank account details', 'error');
                return;
            }
            
            showLoading();
            try {
                // Record withdrawal request
                await db.collection('withdrawals').add({
                    runnerId: currentUser.uid,
                    amount: amount,
                    method: method,
                    mpesaNumber: mpesaNumber,
                    bankDetails: bankDetails,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Deduct from wallet
                await db.collection('runners').doc(currentUser.uid).update({
                    walletBalance: firebase.firestore.FieldValue.increment(-amount)
                });
                
                // Update local data
                runnerData.walletBalance = (runnerData.walletBalance || 0) - amount;
                
                showToast(`Withdrawal request of KSH ${amount.toFixed(2)} submitted successfully!`, 'success');
                closeModal('withdrawalModal');
                loadEarningsData();
                
            } catch (error) {
                console.error('Withdrawal error:', error);
                showToast('Error processing withdrawal: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Utility Functions
        function getCurrentLocation() {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('Location obtained:', currentLocation);
                },
                (error) => {
                    console.error('Geolocation error:', error);
                }
            );
        }

        async function toggleAvailability() {
            const isAvailable = document.getElementById('availabilityToggle').checked;
            
            try {
                await db.collection('runners').doc(currentUser.uid).update({
                    isAvailable: isAvailable,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                runnerData.isAvailable = isAvailable;
                
                showToast(`You are now ${isAvailable ? 'available' : 'unavailable'} for new tasks`, 'success');
            } catch (error) {
                console.error('Toggle availability error:', error);
                showToast('Error updating availability', 'error');
            }
        }

        function showRunnerSupport() {
            const phoneNumber = '+254793312993';
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=Hello%20ERRANDS%20Runner%20Support,%20I%20need%20assistance%20with:`;
            
            if (confirm('Contact Runner Support?\n\nCall: ' + phoneNumber + '\n\nOr open WhatsApp?')) {
                window.open(whatsappUrl, '_blank');
            }
        }

        // UI Helper Functions
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            const pageElement = document.getElementById(`${pageId}Page`);
            if (pageElement) {
                pageElement.classList.add('active');
                
                // Load data for the page if needed
                if (pageId === 'availableTasks') {
                    loadAvailableTasks();
                } else if (pageId === 'myBids') {
                    loadMyBids();
                } else if (pageId === 'activeJobs') {
                    loadActiveJobs();
                } else if (pageId === 'earnings') {
                    loadEarningsData();
                }
            }
        }

        function getCurrentPage() {
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                return activePage.id.replace('Page', '');
            }
            return 'dashboard';
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showToast(message, type = 'info') {
            toast.className = `toast ${type}`;
            document.getElementById('toastMessage').textContent = message;
            
            const icon = document.getElementById('toastIcon');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else {
                icon.className = 'fas fa-info-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showLoading() {
            loadingSpinner.style.display = 'flex';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        function showApp() {
            loginPage.style.display = 'none';
            appContainer.style.display = 'flex';
        }

        function showLogin() {
            loginPage.style.display = 'flex';
            appContainer.style.display = 'none';
            currentUser = null;
            runnerData = {};
        }

        function refreshDashboard() {
            loadDashboardData();
            showToast('Dashboard refreshed!', 'success');
        }

        // Demo functions
        function viewTaskDetails(taskId) {
            showToast('Task details will be shown here', 'info');
        }

        function viewJobFromBid(taskId) {
            showPage('activeJobs');
            setTimeout(() => {
                viewJobDetails(taskId);
            }, 500);
        }

        // Initialize with demo data
        window.addEventListener('load', function() {
            // Show login page
            showLogin();
            
            // Set demo credentials
            document.getElementById('email').value = 'runner@example.com';
            document.getElementById('password').value = 'password123';
        });
    </script>
</body>
</html>
